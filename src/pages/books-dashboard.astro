---
import { getCollection } from 'astro:content';
import Layout2025 from '../layouts/Layout2025.astro';

const books = await getCollection('libros');
const books25 = await getCollection('libros25');
const allBooks = [...books, ...books25];

// Statistics
const totalBooks = allBooks.length;
const booksByYear = allBooks.reduce((acc: Record<string, number>, book) => {
  let year = 'Unknown';
  if ('yearRead' in book.data && typeof book.data.yearRead === 'number') {
    year = String(book.data.yearRead);
  } else if ('monthRead' in book.data && typeof book.data.monthRead === 'string') {
    year = book.data.monthRead.split('-')[0];
  }
  acc[year] = (acc[year] || 0) + 1;
  return acc;
}, {});
const topAuthors = Object.entries(
  allBooks.reduce((acc, book) => {
    acc[book.data.author] = (acc[book.data.author] || 0) + 1;
    return acc;
  }, {} as Record<string, number>)
).sort((a, b) => Number(b[1]) - Number(a[1])).slice(0, 5);
---

<Layout2025 title="ðŸ“š Books Dashboard">
  <main class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-le-textPrimary">Books Dashboard</h1>
    <!-- Statistics Section -->
    <section class="mb-10 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-le-bgHighlight p-6 rounded-lg shadow-md text-center">
        <h2 class="text-xl font-semibold mb-2">Total Books</h2>
        <p class="text-4xl font-bold">{totalBooks}</p>
      </div>
      <div class="bg-le-bgHighlight p-6 rounded-lg shadow-md text-center">
        <h2 class="text-xl font-semibold mb-2">Books by Year</h2>
        <ul>
          {Object.entries(booksByYear).map(([year, count]) => (
            <li class="text-lg">{year}: <span class="font-bold">{count}</span></li>
          ))}
        </ul>
      </div>
      <div class="bg-le-bgHighlight p-6 rounded-lg shadow-md text-center">
        <h2 class="text-xl font-semibold mb-2">Top Authors</h2>
        <ul>
          {topAuthors.map(([author, count]) => (
            <li class="text-lg">{author}: <span class="font-bold">{count}</span></li>
          ))}
        </ul>
      </div>
    </section>

    <!-- Books Grid/List Section -->
    <section>
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold">All Books</h2>
        <!-- Sorting/filtering controls can be added here -->
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {allBooks.map(book => (
          <div class="bg-le-bgCard p-4 rounded-lg shadow-md flex flex-col items-center text-center">
            <img
              src={book.data.cover || book.data.noCover}
              alt={`Cover of ${book.data.title}`}
              class="w-32 h-48 rounded-md shadow-lg mb-4 object-cover"
            />
            <h3 class="text-lg font-bold mb-1">{book.data.title}</h3>
            <p class="text-md text-le-textSecondary mb-1">By {book.data.author}</p>
            <p class="text-sm text-le-textSecondary">
              Year: {'yearRead' in book.data && typeof book.data.yearRead === 'number'
                ? book.data.yearRead
                : ('monthRead' in book.data && typeof book.data.monthRead === 'string'
                  ? book.data.monthRead.split('-')[0]
                  : 'Unknown')}
            </p>
          </div>
        ))}
      </div>
    </section>
  </main>
</Layout2025>
