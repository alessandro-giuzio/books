---
import Layout2025 from '../layouts/Layout2025.astro';
import AddBookForm from '../components/dashboard/AddBookForm.astro';
import { getCollection } from 'astro:content';
import CardConcorrente from '../components/dashboard/CardConcorrente.astro';
import Header2025 from '../components/dashboard/Header2025.vue';
import BookCount from '../components/dashboard/BookCount.astro';
import BookYearCount from '../components/dashboard/BookYearCount.astro';
import IconsTags2025 from '../components/dashboard/IconsTags2025.astro';
import '@styles/globals.css';




const currentPath = Astro.url.pathname;


function activeLink(path: string) {
  const normalize = (p: string) => p.replace(/\/+$/, '') || '/';

  const current = normalize(currentPath);
  const target = normalize(path);

  const isExactMatch = current === target;
  const isSubPath = current.startsWith(target + '/');

  return isExactMatch || isSubPath
    ? 'bg-basque-10 text-white font-semibold uppercase mx-2'
    : 'text-gray-100';
}

  // For other pages, check if current path starts with the given path
/*   const isActive = currentPath.startsWith(path);
  return isActive
    ? 'bg-basque-10 text-white font-semibold uppercase mx-2'
    : 'text-gray-100';
} */

const concorrenti = await getCollection('concorrenti25');

interface Concorrente {
  id: number;
  name: string;
  points: number;
}
export interface Props {
  concorrenti: Concorrente[];
}

const shuffledConcorrenti = concorrenti.sort(() => Math.random() - 0.5);

// Debug: log the current path
console.log('Current path:', currentPath);
---

<Layout2025>
  <div class='min-h-screen flex bg-basque-40 overflow-x-hidden'>
    <!-- Desktop Sidebar -->
    <div class='hidden md:flex w-64 bg-black text-gray-100 flex-col justify-between'>
      <div class='p-4'>
        <nav class='mt-8 space-y-4'>
          <a
            href='/'
            class={`block py-2 px-4 rounded-lg transition-all text-sm font-semibold ${activeLink('/')}`}>
            Home
          </a>
          <a
            href='/liburuak'
            class={`block py-2 px-4 rounded-lg transition-all text-sm font-semibold hover:bg-basque-20 ${activeLink('/liburuak')}`}>
            Liburuak
          </a>
          <a
            href='/lehiakideak'
            class={`block py-2 px-4 rounded-lg transition-all text-sm font-semibold hover:bg-basque-20 ${activeLink('/lehiakideak')}`}>
            Lehiakideak
          </a>
          <a
            href='/2024'
            class={`block py-2 px-4 rounded-lg transition-all text-sm font-semibold hover:bg-basque-20 ${activeLink('/2024')}`}>
            2024
          </a>
        </nav>
      </div>
      <!-- Desktop AddBookForm at bottom of sidebar -->
      <div class='p-4 mt-auto'>
        <AddBookForm />
      </div>
    </div>

    <!-- Main Content Area -->
    <div class='flex-1 px-0 overflow-y-auto bg-black'>
      <!-- Header Component -->
      <Header2025 client:load />

      <!-- Main Content -->
      <main class='mt-6'>
        <div class='bg-black rounded-t-lg shadow-lg p-4 flex flex-col gap-8'>
          <!-- Page Header -->
          <header class='bg-basque-10 shadow-xl rounded-lg px-4 sm:p-6 flex items-center stripes stripes-white stripes-reverse py-6'>
            <h1 class='text-xl md:text-3xl font-semibold text-white shadow-xl'>
              üïµÔ∏è‚Äç‚ôÇÔ∏è Lehiakidearen Informazioa
              <span class='text-lg text-red-500 shadow-xl'>(Konfidentziala!)</span>
            </h1>
          </header>

          <!-- Concorrente Cards Grid -->
          <section>
            <div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-center'>
              {shuffledConcorrenti.map(concorrente => (
                <CardConcorrente concorrente={concorrente} />
              ))}
            </div>
          </section>

          <!-- Statistics Grid -->
          <section>
            <div class='grid grid-cols-1 md:grid-cols-2 gap-6 shadow-lg rounded-lg'>
              <BookCount />
              <BookYearCount />
            </div>
            <div class='mt-6'>
              <IconsTags2025 />
            </div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <!-- Mobile Descriptive Add Book Button -->
  <div class="fixed bottom-16 right-6 md:hidden z-50">
    <button
      id="mobileFormToggle"
      class="bg-basque-10 hover:bg-basque-20 text-white rounded-lg px-4 py-3 shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-basque-20 focus:ring-offset-2 flex items-center gap-2 font-medium"
      aria-label="Gehitu liburu berria"
      title="Gehitu liburu berria">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
      <span class="text-sm">+ Liburu</span>
    </button>
  </div>

  <!-- Mobile Form Modal -->
  <div id="mobileFormModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center p-4 border-b">
        <h3 class="text-xl font-semibold text-gray-900">Gehitu Liburu Berria</h3>
        <button
          id="closeMobileForm"
          class="text-gray-500 hover:text-gray-800 p-1 rounded-full hover:bg-gray-100 transition-colors"
          aria-label="Itxi formularioa">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-4">
        <AddBookForm />
      </div>
    </div>
  </div>
</Layout2025>

<!-- Rest of your script and styles remain the same -->
<script>
  // Mobile form modal functionality
  document.addEventListener('DOMContentLoaded', () => {
    const toggleButton = document.getElementById('mobileFormToggle');
    const modal = document.getElementById('mobileFormModal');
    const closeButton = document.getElementById('closeMobileForm');

    if (toggleButton && modal && closeButton) {
      toggleButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      });

      closeButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.body.style.overflow = '';
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.add('hidden');
          modal.style.display = 'none';
          document.body.style.overflow = '';
        }
      });
    }
  });
</script>

<style>
  @keyframes growWidth {
    from {
      width: 0;
    }
    to {
      width: var(--target-width);
    }
  }

  .progress-bar {
    background-color: #4caf50;
    height: 100%;
    border-radius: 5px;
    animation: growWidth 2s ease-out forwards;
  }

  /* Ensure modal displays properly */
  #mobileFormModal.hidden {
    display: none !important;
  }
</style>